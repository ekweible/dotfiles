#!/bin/bash

# Initialize age encryption by retrieving the age identity from Keeper

set -e

AGE_KEY_FILE="$HOME/.config/chezmoi/key.txt"

# Check if age identity already exists
if [ -f "$AGE_KEY_FILE" ]; then
    echo "âœ… Age identity already exists at $AGE_KEY_FILE"
    exit 0
fi

echo "ðŸ” Setting up age encryption identity..."

# Check if Keeper CLI is available
if ! command -v keeper &> /dev/null; then
    echo "âš ï¸  Keeper Commander CLI not installed. Skipping age identity setup."
    echo "   Install with: brew install keeper-commander"
    echo "   Then manually create $AGE_KEY_FILE with your age identity"
    exit 0
fi

echo ""
echo "ðŸ” Enter your Keeper master password to retrieve age identity"
read -s -p "Password: " KEEPER_PASSWORD
echo ""
echo ""

# Ensure password is cleared from memory on exit (success or failure)
trap 'unset KEEPER_PASSWORD' EXIT

echo "ðŸ“¥ Retrieving age identity from Keeper..."
echo "   Record: Chezmoi AGE Identity"
echo "   Field: key"

# Retrieve the key from Keeper using the 'get' command with JSON output
keeper_exit_code=0
key_data=$(keeper get --format=json --user="evan@weible.me" --password="$KEEPER_PASSWORD" "Chezmoi AGE Identity" 2>&1) || keeper_exit_code=$?

if [ "$keeper_exit_code" -ne 0 ]; then
    echo ""
    echo "âŒ Failed to retrieve record from Keeper (exit code: $keeper_exit_code)"
    if [ "$keeper_exit_code" -eq 5 ]; then
        echo "   This usually means authentication failed or was cancelled"
        echo "   Try running: keeper login"
    fi
    echo "   Error output:"
    echo "$key_data"
    exit 1
fi

# Extract the custom field value using jq
extracted_value=$(echo "$key_data" | jq -r '.custom[]? | select(.label == "key") | .value[]?' 2>/dev/null) || true

if [ -z "$extracted_value" ]; then
    # Try alternate structure (value might not be an array)
    extracted_value=$(echo "$key_data" | jq -r '.custom[]? | select(.label == "key") | .value' 2>/dev/null) || true
fi

key_data="$extracted_value"

# Check if we got valid data
if [ -z "$key_data" ]; then
    echo "âŒ Retrieved empty data for age identity from Keeper"
    echo "   Record: Chezmoi AGE Identity"
    echo "   Field: key"
    echo ""
    echo "   Troubleshooting:"
    echo "   1. Verify the record exists: keeper get \"Chezmoi AGE Identity\""
    echo "   2. Check custom fields: keeper get --format=json \"Chezmoi AGE Identity\" | jq '.custom[] | {type, label}'"
    echo "   3. Make sure the 'key' custom field is populated in Keeper"
    exit 1
fi

# Verify it looks like an age identity
if ! echo "$key_data" | grep -q "AGE-SECRET-KEY-"; then
    echo "âŒ Retrieved data doesn't appear to be a valid age identity"
    echo "   Expected: Format starting with 'AGE-SECRET-KEY-'"
    echo "   Got first 50 chars: ${key_data:0:50}"
    exit 1
fi

# Ensure the directory exists
mkdir -p "$(dirname "$AGE_KEY_FILE")"

# Write the key to file with secure permissions
echo "$key_data" > "$AGE_KEY_FILE"
chmod 600 "$AGE_KEY_FILE"

echo "âœ… Age identity successfully installed at $AGE_KEY_FILE"
echo "   File permissions: $(ls -l "$AGE_KEY_FILE" | awk '{print $1}')"

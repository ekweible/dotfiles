#!/bin/bash

# Import GPG private keys from Keeper on personal/work machines

set -e

# Function to check if Keeper is initialized and authenticated
keeper_is_ready() {
    # Use timeout and redirect stdin to prevent hanging
    timeout 5 keeper whoami < /dev/null &> /dev/null
}

# Function to check if a GPG key is already imported
gpg_key_exists() {
    local key_id="$1"
    gpg --list-secret-keys "$key_id" &> /dev/null
}

# Function to import and trust a GPG key from Keeper
import_gpg_key() {
    local key_id="$1"
    local keeper_record="$2"
    local description="$3"

    if gpg_key_exists "$key_id"; then
        echo "‚úÖ GPG key $key_id ($description) already imported"
        return 0
    fi

    echo "üì• Importing $description GPG key from Keeper..."

    # Retrieve the key from Keeper
    local key_data
    if ! key_data=$(keeper secret get -n "$keeper_record" 2>&1); then
        echo "‚ùå Failed to retrieve $description GPG key from Keeper"
        echo "   Error: $key_data"
        echo "   Record: $keeper_record"
        return 1
    fi

    # Check if we got valid data
    if [ -z "$key_data" ]; then
        echo "‚ùå Retrieved empty data for $description GPG key from Keeper"
        echo "   Record: $keeper_record"
        echo "   Make sure the private key field is populated in Keeper"
        return 1
    fi

    # Verify it looks like a GPG key
    if ! echo "$key_data" | grep -q "BEGIN PGP PRIVATE KEY BLOCK"; then
        echo "‚ùå Retrieved data doesn't appear to be a valid GPG private key"
        echo "   Record: $keeper_record"
        echo "   Expected: ASCII-armored format starting with '-----BEGIN PGP PRIVATE KEY BLOCK-----'"
        return 1
    fi

    # Import the key
    if echo "$key_data" | gpg --import 2>&1; then
        echo "‚úÖ GPG key imported successfully"

        # Set trust level to ultimate for your own key
        echo "üîí Setting trust level to ultimate..."
        echo -e "5\ny\n" | gpg --command-fd 0 --expert --edit-key "$key_id" trust quit

        echo "‚úÖ $description GPG key setup complete"
        return 0
    else
        echo "‚ùå Failed to import $description GPG key"
        return 1
    fi
}

echo "üîê Checking GPG key setup..."

# Check if Keeper CLI is available
if ! command -v keeper &> /dev/null; then
    echo "‚ö†Ô∏è  Keeper Commander CLI not installed. Skipping GPG key import."
    echo "   Install with: brew install keeper-commander"
    exit 0
fi

# Check if Keeper is initialized and authenticated
if ! keeper_is_ready; then
    echo "‚ö†Ô∏è  Keeper Commander is not initialized or authenticated"
    echo "   Run: keeper init"
    echo "   Or re-run: chezmoi apply"
    exit 0
fi

# Import personal GPG key (ekweible)
import_gpg_key \
    "F2B4B87D2390CC45" \
    "keeper://GPG Private Key - ekweible/field/private_key" \
    "personal (ekweible)"

{{ if eq .profile "work" -}}
# Import work GPG key (evanweible-wf)
import_gpg_key \
    "8C997CA8F29161D2" \
    "keeper://GPG Private Key - evanweible-wf/field/private_key" \
    "work (evanweible-wf)"
{{- end }}

echo ""
echo "‚úÖ All GPG keys configured successfully"
